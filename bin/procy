#!/usr/bin/env bash

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    echo "[Error] This script should be sourced, not executed directly."
    echo "        Usage: source procy [host] [port]"
    exit 1
fi

function set_proxy() {
    local host="127.0.0.1"
    local port="10808"

    [[ "$#" -eq 1 ]] && port="$1"
    [[ "$#" -eq 2 ]] && host="$1" && port="$2"

    if [ -n "$SSH_CONNECTION" ]; then
        host="$(echo "$SSH_CONNECTION" | awk '{print $1}')"
        if [ -z "$host" ]; then
            echo "[WARNING] could not get ssh host ip, using localhost instead."
            host="127.0.0.1"
        fi
    fi

    export http_proxy="http://$host:$port"
    export https_proxy="http://$host:$port"
    export all_proxy="http://$host:$port"
}

if [[ "$#" -eq 0 ]] && [[ -n "$http_proxy" || -n "$https_proxy" ]]; then
    unset http_proxy
    unset https_proxy
    unset all_proxy
    echo "proxy removed!"
else
    set_proxy "$@"
    echo "http_proxy=$http_proxy"
    echo "https_proxy=$https_proxy"
    echo "all_proxy=$all_proxy"
fi
