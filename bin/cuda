#!/usr/bin/env python3

import os
import subprocess
import sys
from collections import defaultdict


def collect_pkg_info():
    data = []
    data.append(("platform", sys.platform))
    data.append(("python", sys.version.replace("\n", "")))

    try:
        import PIL  # type: ignore
        data.append(("pillow", PIL.__version__))
    except ImportError:
        data.append(("pillow", None))

    try:
        import cv2  # type: ignore
        data.append(("OpenCV", cv2.__version__))
    except ImportError:
        data.append(("OpenCV", None))

    try:
        import numpy as np  # type: ignore
        data.append(("Numpy", np.__version__))
    except ImportError:
        data.append(("Numpy", None))

    try:
        import torch  # type: ignore
        torch_ver = torch.__version__
        torch_build = "(debug)" if torch.version.debug else ""  # type: ignore
        data.append(("torch", torch_ver + torch_build))
    except ImportError:
        data.append(("torch", None))
        return data

    try:
        import torchvision  # type: ignore
        data.append(("torchvision", torchvision.__version__))  # type: ignore
    except ImportError:
        data.append(("torchvision", None))
    except AttributeError:
        data.append(("torchvision", "unknown"))

    if torch.cuda.is_available():
        devices = defaultdict(list)
        for k in range(torch.cuda.device_count()):
            devices[torch.cuda.get_device_name(k)].append(str(k))
        for name, devids in devices.items():
            data.append(("GPU " + ",".join(devids), name))

        from torch.utils.cpp_extension import CUDA_HOME  # type: ignore

        data.append(("CUDA_HOME", str(CUDA_HOME)))

        if CUDA_HOME is not None and os.path.isdir(CUDA_HOME):
            try:
                nvcc = os.path.join(CUDA_HOME, "bin", "nvcc")
                nvcc = subprocess.check_output(
                    "'{}' -V | tail -n1".format(nvcc), shell=True
                )
                nvcc = nvcc.decode("utf-8").strip()
            except subprocess.SubprocessError:
                nvcc = "Not Available"
            data.append(("NVCC", nvcc))

        cuda_arch_list = os.environ.get("TORCH_CUDA_ARCH_LIST", None)
        if cuda_arch_list:
            data.append(("TORCH_CUDA_ARCH_LIST", cuda_arch_list))
    else:
        data.append(("CUDA available", False))

    return data


def collect_torch_info():
    try:
        import torch.__config__  # type: ignore
        return torch.__config__.show()
    except ImportError:
        # compatible with older versions of pytorch
        from torch.utils.collect_env import get_pretty_env_info  # type: ignore
        return get_pretty_env_info()


def render(data):
    data = (
        f"\033[34m{k:>12}\033[0m: "
        + (f"\033[32m{v}\033[0m" if v else f"\033[33m{v}\033[0m")
        for k, v in data
    )
    return "\n".join(data)


if __name__ == "__main__":
    pkg_info = collect_pkg_info()
    print(render(pkg_info))
    # print(collect_torch_info())
